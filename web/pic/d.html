<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片合成 - 本地缓存版本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #canvas-container {
            width: 600px;
            margin: auto;
            border: 2px dashed #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #drop-area {
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            border: 2px dashed gray;
        }
        canvas {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="w-full max-w-3xl p-6 bg-white shadow-md rounded-lg">
    <h2 class="text-xl font-bold text-center mb-4">拖入两张图片：大图+小图</h2>

    <!-- 拖入区域 -->
    <div id="drop-area" class="border-2 border-dashed border-gray-400 p-6 text-gray-500">
        <p>拖拽或点击这里上传图片（一次性选择两张）</p>
        <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
    </div>

    <!-- 预览区域 -->
    <div id="canvas-container" class="mt-4">
        <canvas id="canvas"></canvas>
    </div>

    <!-- 控制按钮区域 -->
    <div class="mt-4 flex flex-wrap gap-4 justify-center">
        <button id="moveBgUp" class="bg-gray-500 text-white px-4 py-2 rounded">背景图上移</button>
        <button id="moveBgDown" class="bg-gray-500 text-white px-4 py-2 rounded">背景图下移</button>

        <button id="moveSmallUp" class="bg-blue-500 text-white px-4 py-2 rounded">小图上移</button>
        <button id="moveSmallDown" class="bg-blue-500 text-white px-4 py-2 rounded">小图下移</button>

        <button id="scaleSmallUp" class="bg-green-500 text-white px-4 py-2 rounded">小图放大</button>
        <button id="scaleSmallDown" class="bg-green-500 text-white px-4 py-2 rounded">小图缩小</button>

        <button id="resetSettings" class="bg-red-500 text-white px-4 py-2 rounded">重置调整</button>
    </div>

    <!-- 生成按钮 -->
    <button id="saveBtn" class="mt-4 w-full bg-red-500 text-white p-2 rounded hover:bg-red-700">
        下载图片
    </button>
</div>

<script>
    const dropArea = document.getElementById("drop-area");
    const fileInput = document.getElementById("fileInput");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const saveBtn = document.getElementById("saveBtn");

    // 控制按钮
    const moveBgUp = document.getElementById("moveBgUp");
    const moveBgDown = document.getElementById("moveBgDown");
    const moveSmallUp = document.getElementById("moveSmallUp");
    const moveSmallDown = document.getElementById("moveSmallDown");
    const scaleSmallUp = document.getElementById("scaleSmallUp");
    const scaleSmallDown = document.getElementById("scaleSmallDown");
    const resetSettings = document.getElementById("resetSettings");

    let images = [];
    let bgYOffset = parseFloat(localStorage.getItem("bgYOffset")) || 0;
    let smallImgYOffset = parseFloat(localStorage.getItem("smallImgYOffset")) || 0;
    let smallImgScale = parseFloat(localStorage.getItem("smallImgScale")) || 0.4;

    dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("bg-gray-200");
    });

    dropArea.addEventListener("dragleave", () => {
        dropArea.classList.remove("bg-gray-200");
    });

    dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("bg-gray-200");
        handleFiles(e.dataTransfer.files);
    });

    dropArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

    function handleFiles(files) {
        if (files.length !== 2) {
            alert("请一次性上传两张图片（大图+小图）");
            return;
        }
        images = [];
        for (let file of files) {
            let img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                images.push(img);
                if (images.length === 2) processImages();
            };
        }
    }

    function processImages() {
        if (!images.length) return;

        let mainImg = images[0];
        let overlayImg = images[1];

        canvas.width = 1920;
        canvas.height = 1080;

        let scaleFactor = canvas.width / mainImg.width;
        let croppedHeight = Math.min(mainImg.height, canvas.height / scaleFactor);

        ctx.drawImage(mainImg, 0, bgYOffset, mainImg.width, croppedHeight, 0, 0, canvas.width, canvas.height);

        // 小图缩放尺寸
        let newWidth = overlayImg.width * smallImgScale;
        let newHeight = overlayImg.height * smallImgScale;
        let x = (canvas.width - newWidth) / 2;
        let y = (canvas.height - newHeight) / 2 + smallImgYOffset;

        ctx.drawImage(overlayImg, x, y, newWidth, newHeight);

        // 自动保存参数
        localStorage.setItem("bgYOffset", bgYOffset);
        localStorage.setItem("smallImgYOffset", smallImgYOffset);
        localStorage.setItem("smallImgScale", smallImgScale);
    }

    // 调整按钮
    moveBgUp.addEventListener("click", () => { bgYOffset -= 20; processImages(); });
    moveBgDown.addEventListener("click", () => { bgYOffset += 20; processImages(); });
    moveSmallUp.addEventListener("click", () => { smallImgYOffset -= 20; processImages(); });
    moveSmallDown.addEventListener("click", () => { smallImgYOffset += 20; processImages(); });
    scaleSmallUp.addEventListener("click", () => { smallImgScale += 0.05; processImages(); });
    scaleSmallDown.addEventListener("click", () => { smallImgScale = Math.max(0.1, smallImgScale - 0.05); processImages(); });

    // 重置按钮
    resetSettings.addEventListener("click", () => {
        bgYOffset = 0;
        smallImgYOffset = 0;
        smallImgScale = 0.4;
        localStorage.clear();
        if (images.length === 2) processImages();
    });

    // 下载保存
    saveBtn.addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = "merged-image.png";
        link.href = canvas.toDataURL();
        link.click();
    });

</script>

</body>
</html>